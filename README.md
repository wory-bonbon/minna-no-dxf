# みんなのDXF / Minna-no-DXF

DXF 計測ツール **Minna-no-DXF** のリポジトリです。以下はツールの UI の概要です。

![DXF Measure UI](assets/DXF_Measure_UI.png)

<!-- ここからアップロードした Markdown の内容を貼り付け -->

# DXF 計測ツール v41 開発者向け機能概要　*ユーザーガイドは後日配布予定

対象: `dxf-measure-v41.html`

本ドキュメントは、同バージョンのスタンドアロン版 DXF 計測ツールに実装されている主要機能をカテゴリ別に整理したものです。

## 概要
- 単一 HTML（Preact + Tailwind）で動作するブラウザ完結型の DXF ビューア／計測ツール。
- DXF の `BLOCK`/`INSERT`/`LWPOLYLINE`/`POLYLINE`/`LINE`/`TEXT`/`MTEXT` を解析し、パーツ単位の表示・計測に対応。
- A/B 点スナップ、沿い距離・直線距離・幅/丈・パーツ回転の管理、計測ログ保存と CSV/SVG/PNG/PDF 書き出しを提供。
- DXF ファイルはボタン選択とドラッグ＆ドロップの双方に対応し、ローカル上で完結。

## ファイル入出力
- 読み込み
  - ヘッダーの「ファイル」ボタン、サイドパネルのファイル入力、キャンバスへのドラッグ＆ドロップで `.dxf` を読み込む。
  - 文字コードは `Shift_JIS` → `MS932` → `UTF-8` の順で自動判別し、`SECTION`/`ENTITIES` の存在で正規データか確認。
  - 読み込み時は A/B 選択、ポリラインロック、表示パーツ、初回フィット状態をリセットし、ドキュメントキーも再計算。
- 書き出し
  - 計測ログを CSV へ出力（BOM 付き）。`No/Time/File/Part/Note/Width/Length/Straight/Along` を mm 換算で保存。
  - ヘッダーの書き出しグループから `PDF`/`SVG`/`PNG` を生成。`表示(全体/選択)`/`ALL` を切替えられ、目盛り描画（スケールバー）ON/OFF も可能。
  - `PNG` は透過背景・300dpi 指定、`SVG` は 1:1 実寸出力で stroke=0.17mm。サイドパネルにも 1:1 固定の SVG ショートカットを用意。

## DXF 解析
- group code/value のペア配列化で全レコードを走査し、`HEADER` の `$TDCREATE`/`$TDUPDATE` を取得。
- `BLOCK` 定義（基準点 10/20）と `INSERT`（名称 2・挿入点 10/20・スケール 41/42・回転 50）を解きほぐし、ワールド座標へ展開。
- `LWPOLYLINE`/`POLYLINE`/`LINE` のポリライン情報、`TEXT`/`MTEXT` のラベル情報を抽出し、バウンディングボックスとパーツ名一覧を作成。

## 幾何処理・座標系
- ビュー行列（scale/tx/ty）と画面回転 `rot`（0/90/180/270°）でワールド→画面変換。
- `fitToCanvas` で回転後のバウンディングを収めるスケール・平行移動を算出。回転時の自動フィットをトグル可。
- パーツごとに 90° 単位の表示回転を保持（中心は bbox 中央）。全体回転と独立して記録される。
- グリッド描画は 100×`scale` ピッチを基準に、8px 以上で表示。スナップ結果は `tagOffset` を用いて視認しやすく調整。

## 描画・UI
- Canvas へ背景／グリッド／ポリライン／ラベル／計測オーバーレイを描画。ロック中ポリラインは太線で強調。
- 画面左上：操作モードヒント（パン／ポリライン選択／A/B 選択状態）を表示。
- 画面右上：A/B 間の要約カード（幅・丈・直線距離・沿い距離）を表示。
- ログ表示は下部ドック（固定）またはフローティングウィンドウで切替可能。位置・サイズは永続化。

### トップヘッダー（オーバーレイ）
- `DXF Measure` ロゴとファイル名表示（最大 24 文字）。
- 「ファイル」ボタンで `.dxf` 読み込み（再読み込み時は A/B・ロック・パーツ選択をリセット）。
- `書き出し` グループ
  - `表示(全体/選択)` と `ALL` のスコープを選択。
  - `目盛り` トグルでスケールバー描画の ON/OFF。
  - `PDF`・`SVG`・`PNG` ボタンから即時出力。PNG は 300dpi 固定。
- 全体回転コントロール
  - `↺全体` / `↻全体` / `全体0°` で表示回転を 90° 刻み操作。現在角度を `rot°` として表示。
  - `Fit全体` / `Fitロック` ボタンでワールド全体 or ロック中ポリラインへフィット。
- 単位スケール入力（mm 換算倍率）。
- 表示トグル：`ラベル` / `ガイド`（幅丈ガイド線）/ `精度タグ`（拘束逸脱量）。
- パーツ操作
  - パーツ選択ドロップダウン（`ALL` / パーツ名）。ダブルクリックでリネーム入力を呼び出し。
  - 選択中パーツを `↺パーツ` / `↻パーツ` / `パーツ0°` で回転。現在角度を表示。
- ポリラインロックとリセット
  - `同一ポリラインにロック` チェックでロックの ON/OFF。
  - `選択解除`（ロック解除のみ）、`選択解除＋A/B同時リセット`、`A/Bリセット` を個別実行。
- ログ制御：`ログ▲/ログ▼` で表示 ON/OFF、`ログPOP`（フロート）/`ドック` を切替。切替時は自動で表示 ON。

### サイドパネル
- タイトルとファイル入力（任意の `.dxf` を直接選択可能）。
- `単位スケール（DXF → 出力）` の詳細設定と使用例ラベル。
- `書き出し (SVG)` セクション：ヘッダーと同じスコープ選択を参照し、1:1 実寸 SVG を出力。
- `表示ブロック` ドロップダウン：`ALL` または個別パーツを選択。ダブルクリックでリネーム入力（Enter 確定 / Esc 取消 / フォーカスアウト自動保存）。
- `同一ポリラインにロック` セクション：状態表示（対象ポリライン番号と名称）、`ロック解除`、`A/Bリセット` を提供。
- `回転 & フィット`
  - 現在角度を表示しつつ `↺ +90°` / `↻ -90°` / `0°` ボタンで全体回転。
  - `回転時に自動フィット` チェックで回転後に自動フィット。
  - `全体にフィット` / `ロックにフィット` ボタン。
- `幅/丈の基準`：`画面基準（回転後）` / `DXF座標基準` のラジオボタンと補足説明。
- 計測結果
  - A/B 座標を常時表示。計測成立時は直線距離・幅/丈（符号も表示）・沿い距離（短経路／長経路、閉ループ時）・外周長をまとめて表示。
  - A/B が同一ポリラインでない場合は警告表示。
- 計測ログ
  - `表示` チェック、`CSV書き出し`、`全消去` ボタン。
  - ログ項目は最新順で、A/B 座標・パーツ名（ダブルクリックでリネーム呼び出し）・幅/丈/直線/沿い距離・自由記述欄（プレースホルダ「例：股ぐり、肩線…」）を持つ。
  - `削除` ボタンで単項目削除。入力中のノートはリアルタイムで保存。

### ログドロワー（フロート時）
- `ログPOP` で表示すると自由移動・サイズ変更が可能。ヘッダーをドラッグで移動し、底辺/右下グリップでリサイズ。座標とサイズは `dxf-log-rect` に保存される。
- 浮遊ウィンドウのツールバーから `CSV` / `クリア` / `ドックに戻す` / `閉じる` を操作できる。
- ドック表示中もヘッダーから `ログPOP` を押すだけでフロート表示へ切り替わる。

## 計測機能
- スナップ
  - 頂点優先スナップ（半径 12px）。該当なしは線分最近点。
  - ロック中は対象ポリライン上のみスナップ。ロック解除で自由選択に戻る。
- A/B 操作
  - 最初のクリックでロック対象確定、続くクリックで A/B を交互に設定。
  - Shift 併用で水平/垂直拘束。拘束時は det 判定を行い厳密な交点を採用。
  - A/B はヘッダーのリセットボタンから個別に解除可能。
  - ※データによってはShiftが効かない場合がありその際は幅/丈を参照。
- 計測値
  - 直線距離（②灰点線）、幅/丈（③橙 L 字）、沿い距離（①青太線）を描画。
  - 沿い距離は短経路/長経路を計算し、閉ループでは外周長も表示。非閉鎖ポリラインでは短経路のみ。
  - `精度タグ` ON で拘束誤差 `dx/dy` を注記。
  - タグ類はドラッグで位置調整可能（セッション限定）。

## パーツ管理
- パーツ表示名は `dxf-name-map:{docKey}` に永続化。ヘッダー、サイドパネル、計測ログから同一リネーム UI を呼び出せる。
- パーツ回転は `dxf-block-rot:{docKey}` に保存。パーツ選択時のみ `↺パーツ`/`↻パーツ`/`パーツ0°` が有効。
- ログ項目のパーツ名はリネームマップを参照して表示される。

## ログ・書き出し
- 計測ログは `dxf-measure-log:{docKey}` へ自動保存。ドキュメント切替時に遅延書込みで永続化。
- CSV は BOM 付き UTF-8。Excel などで開いても文字化けしにくい形式。
- ログドロワー設定は `dxf-log-dock` と `dxf-log-rect` に保持。ヘッダー操作で常に最新状態に保存される。

## 永続化・ドキュメントキー
- `docKey` 優先順
  1. `HEADER.$TDCREATE`
  2. DXF 全文ハッシュ（SHA-256 先頭 16 文字）
  3. 文字列長などを基にした簡易ハッシュ
- 旧版キー（`name:size:lastModified`）からの移行ロジックを実装し、既存のパーツ名マップを引き継ぐ。

## 操作（マウス／キーボード）
- 左クリック：スナップ選択（ロック対象／A/B）
- Shift+左クリック：水平/垂直拘束
- ホイール：ポインタ中心ズーム（`passive:false` で preventDefault）
- 左ドラッグ：パン（`grabbing` カーソル）
- DXF ファイルのドラッグ＆ドロップ読み込みに対応

## 既知の制約・注意
- 円弧・スプラインなど未対応エンティティは描画対象外。
- 全体回転は Canvas 描画に適用されるが、書き出し（SVG/PNG/PDF）はパーツ回転のみ反映し、画面回転は反映しない。
- 沿い距離は A/B が同一ポリライン上の場合のみ計算。ポリラインを跨ぐ場合は未定義。
- ①②③ タグの位置調整は永続化されない（セッション限定）。

## 実装メモ（技術）
- Preact (`preact/compat`) を React API 互換で使用。`ReactDOM.createRoot` のシムを内蔵。
- Tailwind CDN を用いた軽量スタイル定義。独自スクロールバーのスタイリングを付与。
- Canvas 描画はピクセルスナップで滲みを軽減し、ロック時のポリラインを強調。
- Ray × segment 交差判定を実装し、Shift 拘束時の交点を厳密に算出。
- Fit 処理では余白 40px を確保し、回転後のバウンディングからスケール・平行移動を導出。

---
本ドキュメントはバージョン 0922-41 のコードベースをもとに作成しています。将来の更新で UI や仕様が変更される可能性があります。

<!-- ここまで -->